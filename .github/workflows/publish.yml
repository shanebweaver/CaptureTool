name: Publish to Microsoft Store

on:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed
    branches:
      - main

jobs:
  publish:
    runs-on: windows-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    permissions:
      actions: read
      contents: read
    
    steps:
    - name: Download x64 artifacts
      uses: actions/download-artifact@v7
      with:
        name: StorePackage-x64
        path: packages/x64
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Download arm64 artifacts
      uses: actions/download-artifact@v7
      with:
        name: StorePackage-arm64
        path: packages/arm64
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: List downloaded packages
      run: |
        Write-Host "Downloaded packages:"
        Get-ChildItem -Path packages -Recurse -File | ForEach-Object { Write-Host $_.FullName }
      shell: pwsh
    
    - name: Prepare packages for upload
      run: |
        # Create a flat directory structure for the Store action
        New-Item -Path packages-flat -ItemType Directory -Force

        # Find all .msix packages in the downloaded artifacts
        $msixFiles = Get-ChildItem -Path packages -Recurse -Filter "*.msix"

        if (-not $msixFiles -or $msixFiles.Count -eq 0) {
          Write-Error "No .msix files were found in the 'packages' directory. Ensure the build produced .msix artifacts and they were downloaded correctly."
          exit 1
        }

        foreach ($file in $msixFiles) {
          Copy-Item $file.FullName -Destination (Join-Path 'packages-flat' $file.Name)
          Write-Host "Copied: $($file.Name)"
        }
        Write-Host "Packages ready for upload:"
        Get-ChildItem -Path packages-flat | ForEach-Object { Write-Host $_.FullName }
      shell: pwsh
    
    - name: Setup Microsoft Store Developer CLI
      uses: microsoft/microsoft-store-apppublisher@v1.1
    
    - name: Configure Microsoft Store Developer CLI
      run: msstore reconfigure --tenantId ${{ secrets.PARTNER_CENTER_TENANT_ID }} --sellerId ${{ secrets.PARTNER_CENTER_SELLER_ID }} --clientId ${{ secrets.PARTNER_CENTER_CLIENT_ID }} --clientSecret ${{ secrets.PARTNER_CENTER_CLIENT_SECRET }}
      shell: pwsh
    
    - name: Publish App packages
      env:
        STORE_PRODUCT_ID: ${{ secrets.STORE_PRODUCT_ID }}
      run: |
        # Publish all .msix packages in the packages-flat directory
        $packagesPath = "${{ github.workspace }}/packages-flat"
        $msixFiles = Get-ChildItem -Path $packagesPath -Filter "*.msix"
        $failedPackages = @()
        
        foreach ($file in $msixFiles) {
          Write-Host "Publishing: $($file.FullName)"
          try {
            msstore publish "$($file.FullName)" -id $env:STORE_PRODUCT_ID
            Write-Host "Successfully published: $($file.Name)"
          }
          catch {
            Write-Error "Failed to publish $($file.Name): $_"
            $failedPackages += $file.Name
          }
        }
        
        if ($failedPackages.Count -gt 0) {
          Write-Error "Failed to publish the following packages: $($failedPackages -join ', ')"
          exit 1
        }
        
        Write-Host "All packages published successfully"
      shell: pwsh
