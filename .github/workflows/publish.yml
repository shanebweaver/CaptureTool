name: Publish to Microsoft Store

on:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed
    branches:
      - main

jobs:
  publish:
    runs-on: windows-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    strategy:
      matrix:
        platform: [x64, arm64]
    
    permissions:
      actions: read
      contents: read
    
    steps:
    - name: Download ${{ matrix.platform }} artifacts
      uses: actions/download-artifact@v8
      with:
        name: StorePackage-${{ matrix.platform }}
        path: packages
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Microsoft Store Developer CLI
      uses: microsoft/microsoft-store-apppublisher@v1.3
    
    - name: Configure Microsoft Store Developer CLI
      shell: pwsh
      env:
        PARTNER_CENTER_TENANT_ID: ${{ secrets.PARTNER_CENTER_TENANT_ID }}
        PARTNER_CENTER_SELLER_ID: ${{ secrets.PARTNER_CENTER_SELLER_ID }}
        PARTNER_CENTER_CLIENT_ID: ${{ secrets.PARTNER_CENTER_CLIENT_ID }}
        PARTNER_CENTER_CLIENT_SECRET: ${{ secrets.PARTNER_CENTER_CLIENT_SECRET }}
      run: |
        msstore reconfigure `
          --tenantId $env:PARTNER_CENTER_TENANT_ID `
          --sellerId $env:PARTNER_CENTER_SELLER_ID `
          --clientId $env:PARTNER_CENTER_CLIENT_ID `
          --clientSecret $env:PARTNER_CENTER_CLIENT_SECRET
    
    - name: Publish ${{ matrix.platform }} package
      shell: pwsh
      env:
        STORE_PRODUCT_ID: ${{ secrets.STORE_PRODUCT_ID }}
      run: |
        $msixFile = Get-ChildItem -Path packages -Recurse -Filter "*.msix" | Select-Object -First 1
        if (-not $msixFile) {
          throw "No .msix file found for ${{ matrix.platform }}"
        }
        
        msstore publish "$($msixFile.FullName)" -id $env:STORE_PRODUCT_ID -v
