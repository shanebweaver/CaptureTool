# GitHub Copilot Instructions for CaptureTool

## Project Overview

CaptureTool is a lightweight and efficient Windows screen capture utility built with:
- **C++20** for native Windows interop (CaptureInterop project)
- **C# 14 / .NET 10** for application logic and UI
- **Windows App SDK 1.8** and **WinUI 3** for modern Windows UI
- **vcpkg** for C++ dependency management (currently using WIL - Windows Implementation Libraries)

The application follows Domain-Driven Design (DDD) and Clean Architecture patterns with separated concerns:
- **Application**: Application layer with use cases, services, and ViewModels (replaces Core)
- **Domain**: Domain layer with business logic for Capture and Edit features (singular, not Domains)
- **Infrastructure**: Infrastructure services including feature management and platform-specific implementations
- **UI.Windows**: WinUI 3 presentation layer

## Build and Test Environment

### Prerequisites
- Windows-based development environment
- .NET 10 SDK
- MSBuild (via Visual Studio or Build Tools)
- vcpkg (included as submodule)

### Building the Application

1. **Restore vcpkg dependencies:**
   ```powershell
   vcpkg\bootstrap-vcpkg.bat
   vcpkg\vcpkg.exe install
   ```

2. **Restore .NET dependencies:**
   ```powershell
   dotnet restore
   ```

3. **Build the solution:**
   ```powershell
   # For development (x64)
   msbuild CaptureTool.slnx /p:Configuration=Release /p:Platform=x64
   
   # For ARM64
   msbuild CaptureTool.slnx /p:Configuration=Release /p:Platform=arm64
   ```

### Running Tests

Run the test projects individually:
```powershell
dotnet test src\CaptureInterop.Tests\CaptureInterop.Tests.vcxproj -p:Platform=x64
dotnet test src\CaptureTool.Application.Tests\CaptureTool.Application.Tests.csproj
dotnet test src\CaptureTool.Infrastructure.Tests\CaptureTool.Infrastructure.Tests.csproj
dotnet test src\CaptureTool.Domain.Capture.Tests.Windows\CaptureTool.Domain.Capture.Tests.Windows.csproj -p:Platform=x64
dotnet test src\CaptureTool.Domain.Edit.Tests.Windows\CaptureTool.Domain.Edit.Tests.Windows.csproj -p:Platform=x64
```

## Code Standards and Style

### C# Code
- **Language Version**: C# 14
- **Target Framework**: .NET 10
- **Nullable Reference Types**: Enabled
- **Implicit Usings**: Enabled
- **AOT Compatible**: Yes
- **Trimmable**: Yes
- **Warnings as Errors**: Enabled
- **Code Style in Build**: Enforced
- **Primary Constructors**: Not preferred (see .editorconfig)

### Architecture Patterns
- Follow **MVVM** pattern for UI-related code
- Follow **DDD (Domain-Driven Design)** principles for domain logic
- Use **interfaces** for abstraction (projects ending in `.Interfaces`)
- Platform-specific implementations go in projects ending in `.Windows`
- Keep business logic in `Domain` projects (singular)
- Application layer services and use cases in `Application` projects
- Infrastructure concerns in `Infrastructure` projects
- Tests in projects ending in `.Tests`

### Project Organization
- `Application.*`: Application layer with use cases, services, and ViewModels
- `Domain.*`: Domain layer with business logic (Capture, Edit)
- `Infrastructure.*`: Infrastructure layer with services and platform implementations
- `UI.Windows`: WinUI 3 presentation layer
- `Common`: Shared utilities and base classes
- `CaptureInterop`: Native C++ interop layer
- `*.Tests`: Test projects (both C# and C++ test projects)

### DDD Layer Details
- **Application.Interfaces**: Use case interfaces and ViewModel interfaces
- **Application.Implementations**: Use case implementations, ViewModels, and application services
- **Application.Tests**: Application layer tests
- **Domain.Capture.Interfaces**: Capture domain interfaces
- **Domain.Capture.Implementations.Windows**: Windows-specific capture implementations
- **Domain.Edit.Interfaces**: Edit domain interfaces  
- **Domain.Edit.Implementations.Windows**: Windows-specific edit implementations
- **Infrastructure.Interfaces**: Infrastructure service interfaces
- **Infrastructure.Implementations**: Cross-platform infrastructure implementations
- **Infrastructure.Implementations.Windows**: Windows-specific infrastructure
- **Infrastructure.Implementations.FeatureManagement**: Feature flag management

## Guidelines for Making Changes

### When Adding Features
1. Start with interface definitions in `.Interfaces` projects
2. Implement in corresponding `.Implementations` or `.Implementations.Windows` projects
3. Add tests in corresponding `.Tests` projects
4. Add use cases in `Application.Implementations/UseCases` if needed
5. Update ViewModels in `Application.Implementations/ViewModels` if UI is affected
6. Update UI.Windows if new UI elements are needed

### When Fixing Bugs
1. First, add a failing test that reproduces the bug (if applicable)
2. Fix the bug in the appropriate layer (Application, Domain, or Infrastructure)
3. Verify the test passes
4. Run all related tests to ensure no regressions

### When Refactoring
1. Ensure all existing tests pass before starting
2. Make incremental changes
3. Run tests frequently during refactoring
4. Update documentation if public APIs change

## Platform-Specific Considerations

- **Windows-only**: This is a Windows-specific application
- **Platform targets**: x64 and ARM64
- **Windows App SDK**: Required for UI layer
- **Native interop**: Use CaptureInterop project for Windows API calls requiring C++
- **vcpkg**: Managed dependencies should be added to `vcpkg.json`

## Testing Guidelines

- All test projects use the same platform configuration as the main projects (x64 or ARM64)
- Both C# and C++ test projects are supported (C++ tests using vcxproj, C# tests using csproj)
- Unit tests should be fast and isolated
- Mock external dependencies using interfaces
- Test projects follow the naming convention: `[ProjectName].Tests`

## Documentation

- Update README.md for user-facing changes
- Update SECURITY.md for security-related changes
- Use XML documentation comments for public APIs
- Keep code comments minimal and focused on "why" not "what"

## Dependencies

### Adding NuGet Packages
- Central Package Management is used (Directory.Packages.props)
- Add package versions to Directory.Packages.props first
- Reference packages in individual projects without version numbers

### Adding vcpkg Dependencies
- Add to vcpkg.json in the root
- Run `vcpkg install` to restore
- Only used for C++ projects (CaptureInterop)

## CI/CD

- **Pull Requests**: Test workflow runs automatically
- **Main Branch**: Build workflow creates store packages for both x64 and ARM64
- All tests must pass before merging
- Treat warnings as errors - they must be fixed

## Common Tasks

### Adding a New Feature Flag
1. Define in Infrastructure.Implementations.FeatureManagement
2. Use via Infrastructure.Interfaces

### Adding a New Capture Mode
1. Define interface in Domain.Capture.Interfaces
2. Implement in Domain.Capture.Implementations.Windows
3. Add tests in Domain.Capture.Tests.Windows
4. Create use case in Application.Implementations/UseCases
5. Wire up in ViewModels and UI

### Adding a New Edit Tool
1. Define interface in Domain.Edit.Interfaces
2. Implement in Domain.Edit.Implementations.Windows
3. Add tests in Domain.Edit.Tests.Windows
4. Create use case in Application.Implementations/UseCases if needed
5. Wire up in ViewModels and UI

### Adding a New Use Case
1. Define interface in Application.Interfaces/UseCases
2. Implement in Application.Implementations/UseCases
3. Add tests in Application.Tests/UseCases
4. Register in DependencyInjection extensions
5. Inject into ViewModels as needed

## Best Practices for Copilot

- Always build the solution after making changes to verify compilation
- Run relevant tests after code changes
- Respect the existing architecture and project organization
- Use existing patterns and conventions in the codebase
- When in doubt, look at similar existing code for reference
- Keep changes minimal and focused on the specific issue
- Don't remove working code unless explicitly required
- Follow the platform-specific guidelines (Windows-only considerations)
